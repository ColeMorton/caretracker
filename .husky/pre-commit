#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

set -e  # Exit on any error

echo "ğŸš€ Running pre-commit validation..."

# Node.js version validation
echo "ğŸ” Validating Node.js version..."
REQUIRED_NODE_VERSION=$(cat .nvmrc)
CURRENT_NODE_VERSION=$(node --version | sed 's/v//')

if [ "$CURRENT_NODE_VERSION" != "$REQUIRED_NODE_VERSION" ]; then
  echo "âŒ Node.js version mismatch!"
  echo "   Required: $REQUIRED_NODE_VERSION"
  echo "   Current:  $CURRENT_NODE_VERSION"
  echo "ğŸ’¡ Run: nvm use $REQUIRED_NODE_VERSION"
  exit 1
fi

echo "âœ… Node.js version matches ($CURRENT_NODE_VERSION)"

# Pre-commit lockfile validation
echo "ğŸ” Validating pnpm lockfile..."

# Check if lockfile is up to date
if ! pnpm install --frozen-lockfile --prefer-offline 2>/dev/null; then
  echo "âŒ pnpm-lock.yaml is out of sync with package.json files!"
  echo "ğŸ’¡ Run pnpm install to update the lockfile, then commit again."
  exit 1
fi

echo "âœ… Lockfile validation passed"

# TypeScript type checking
echo "ğŸ” Running TypeScript type checking..."
if ! pnpm typecheck 2>/dev/null; then
  echo "âŒ TypeScript type checking failed!"
  echo "ğŸ’¡ Fix type errors before committing."
  exit 1
fi

echo "âœ… TypeScript type checking passed"

# Run lint-staged for code quality
echo "ğŸ¨ Running code quality checks..."
npx lint-staged

echo "ğŸ‰ All pre-commit checks passed!"
